<!DOCTYPE html><html data-bs-theme="light" itemscope="" itemtype="http://schema.org/WebPage" lang="zh-hans"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="manifest" href="https://www.shellio.cc/manifest.webmanifest"/><link rel="alternate" type="application/rss+xml" href="https://www.shellio.cc/series/rocketmq/index.xml"/><meta name="description" content="RocketMQ"/><link rel="icon" href="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_16x16_resize_box_3.png" sizes="16x16" type="image/png"/><link rel="icon" href="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_32x32_resize_box_3.png" sizes="32x32" type="image/png"/><link rel="icon" href="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_150x150_resize_box_3.png" sizes="150x150" type="image/png"/><link rel="apple-touch-icon" href="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_180x180_resize_box_3.png" sizes="180x180" type="image/png"/><link rel="icon" href="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_192x192_resize_box_3.png" sizes="192x192" type="image/png"/><link rel="mask-icon" href="/mask-icon.svg" color="#000000"/><meta property="og:title" content="RocketMQ"/><meta property="og:description" content="一个只爱折腾技术的普通人"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.shellio.cc/series/rocketmq/"/><meta itemprop="name" content="RocketMQ"/><meta itemprop="description" content="一个只爱折腾技术的普通人"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="RocketMQ"/><meta name="twitter:description" content="一个只爱折腾技术的普通人"/><title>RocketMQ - 2/3 - 专栏 - 程序员安仔</title>
<link href="/css/hb.dcd71dae06d8a31fa28a6a2cc0fc6834cd77d4888285120d1083becec70aed63.css" rel="stylesheet"/><script src="/js/init.577d4e90bff5601d5756fcf799b0e53568bf56cea3b80fe43f66c9d365e8100c.js" integrity="sha256-V31OkL/1YB1XVvz3mbDlNWi/Vs6juA/kP2bJ02XoEAw="></script></head><body><noscript><div class="alert alert-danger text-center rounded-0" role=alert><svg aria-hidden="true" class="bi bi-exclamation-square-fillbi bi-exclamation-square-fill hi-svg-inline me-2" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm6 4c.535.0.954.462.9.995l-.35 3.507a.552.552.0 01-1.1.0L7.1 4.995A.905.905.0 018 4m.002 6a1 1 0 110 2 1 1 0 010-2"/></svg>你的浏览器不支持 JavaScript。</div></noscript><header class="hb-header"><nav class="hb-header-nav navbar navbar-expand-lg"><div class="container-fluid"><a class="navbar-brand d-flex align-items-center" href="/"><img src="https://www.shellio.cc/images/logo_hu3f5eb531558986e612421c7146e04118_941594_0x64_resize_box_3.png" alt="Logo" width="64" height="64" class="hb-header-logo d-inline-block align-text-top me-2"/>程序员安仔</a><div class="d-flex order-5"><div class="search-modal-toggle hb-header-search-form position-relative d-flex ms-lg-1"><button type="button" class="hb-header-search-icon border-0 bg-transparent px-2" aria-label="Toggle search">
<svg aria-hidden="true" class="bi bi-searchbi bi-search hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1.007 1.007.0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"></path></svg></button>
<input class="form-control rounded-5 d-none d-lg-block ms-lg-1" id="hb-header-search-input" placeholder="搜索"/>
<span class="hb-header-search-keys position-absolute d-none d-lg-block"><kbd>CTRL</kbd>
<kbd>K</kbd></span></div><button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#hb-header-content" aria-controls="hb-header-content" aria-label="Toggle navigation"><svg aria-hidden="true" class="bi bi-three-dotsbi bi-three-dots hi-svg-inline" fill="currentcolor" height="1.25em" viewBox="0 0 16 16" width="1.25em" xmlns="http://www.w3.org/2000/svg"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"></path></svg></button></div><div class="offcanvas offcanvas-lg offcanvas-end" tabindex="-1" id="hb-header-content" aria-labelledby="hb-header-content-label"><div class="offcanvas-header"><h5 class="offcanvas-title" id="hb-header-content-label">程序员安仔</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div><div class="offcanvas-body"><ul class="hb-header-menus navbar-nav flex-row flex-wrap"><li class="hb-header-menu nav-item col-6 col-lg-auto"><a class="nav-link" href="https://www.shellio.cc/docs/"><svg aria-hidden="true" class="bi bi-bookbi bi-book hi-svg-inline hb-header-menu-icon me-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5.0 000 2.5v11a.5.5.0 00.707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5.0 00.78.0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5.0 0016 13.5v-11a.5.5.0 00-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"></path></svg>系列教程</a></li><li class="hb-header-menu dropdown nav-item col-12 col-lg-auto"><a class="nav-link pe-0 d-inline-flex align-items-center" href="/blog/"><svg aria-hidden="true" class="hi-svg-inline hb-header-menu-icon me-1" fill="currentcolor" height="1em" viewBox="0 0 512 512" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M192 32c0 17.7 14.3 32 32 32 123.7.0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1.0 224 0c-17.7.0-32 14.3-32 32zm0 96c0 17.7 14.3 32 32 32 70.7.0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7.0-32 14.3-32 32zM96 144c0-26.5-21.5-48-48-48S0 117.5.0 144V368c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144H128v96h16c26.5.0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48V144z"></path></svg>博客</a>
<a class="nav-link ps-0 d-inline-flex" href="#" id="header-menu-blog" role="button" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle Dropdown</span><svg aria-hidden="true" class="bi bi-chevron-compact-downbi bi-chevron-compact-down hi-svg-inline" fill="currentcolor" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1.553 6.776a.5.5.0 01.67-.223L8 9.44l5.776-2.888a.5.5.0 11.448.894l-6 3a.5.5.0 01-.448.0l-6-3a.5.5.0 01-.223-.67z"></path></svg></a><ul class="hb-header-submenus dropdown-menu" aria-labelledby="header-menu-blog" data-bs-popper="none"><li><a class="hb-header-submenu dropdown-item d-flex align-items-center active" href="https://www.shellio.cc/series/"><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-columnsbi bi-columns hi-svg-inline" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M0 2a1 1 0 011-1h14a1 1 0 011 1v12a1 1 0 01-1 1H1a1 1 0 01-1-1zm8.5.0v8H15V2zm0 9v3H15v-3zm-1-9H1v3h6.5zM1 14h6.5V6H1z"></path></svg></div><div class="dropdown-item-content"><div class="dropdown-item-title mb-1">专栏</div><p class="dropdown-item-desc mb-0 text-wrap">所有专栏。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://www.shellio.cc/authors/"><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-pencilbi bi-pencil hi-svg-inline" fill="currentcolor" height="2em" style="color:#0f5e97" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M12.146.146a.5.5.0 01.708.0l3 3a.5.5.0 010 .708l-10 10a.5.5.0 01-.168.11l-5 2a.5.5.0 01-.65-.65l2-5a.5.5.0 01.11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5.0 01.5.5v.5h.5a.5.5.0 01.5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5.0 015 12.5V12h-.5a.5.5.0 01-.5-.5V11h-.5a.5.5.0 01-.468-.325z"></path></svg></div><div class="dropdown-item-content"><div class="dropdown-item-title mb-1">作者</div><p class="dropdown-item-desc mb-0 text-wrap">作者列表。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://www.shellio.cc/categories/"><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-folderbi bi-folder hi-svg-inline" fill="currentcolor" height="2em" style="color:orange" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M.54 3.87.5 3a2 2 0 012-2h3.672a2 2 0 011.414.586l.828.828A2 2 0 009.828 3h3.982a2 2 0 011.992 2.181l-.637 7A2 2 0 0113.174 14H2.826A2 2 0 01.835 12.181l-.637-7a1.99 1.99.0 01.342-1.31zM2.19 4a1 1 0 00-.996 1.09l.637 7a1 1 0 00.995.91h10.348a1 1 0 00.995-.91l.637-7A1 1 0 0013.81 4H2.19zm4.69-1.707A1 1 0 006.172 2H2.5a1 1 0 00-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"></path></svg></div><div class="dropdown-item-content"><div class="dropdown-item-title mb-1">分类</div><p class="dropdown-item-desc mb-0 text-wrap">所有分类。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://www.shellio.cc/archives/"><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-archivebi bi-archive hi-svg-inline" fill="currentcolor" height="2em" style="color:384955" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M0 2a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1v7.5A2.5 2.5.0 0112.5 15h-9A2.5 2.5.0 011 12.5V5A1 1 0 010 4zm2 3v7.5A1.5 1.5.0 003.5 14h9a1.5 1.5.0 001.5-1.5V5zm13-3H1v2h14zM5 7.5a.5.5.0 01.5-.5h5a.5.5.0 010 1h-5A.5.5.0 015 7.5"></path></svg></div><div class="dropdown-item-content"><div class="dropdown-item-title mb-1">归档</div><p class="dropdown-item-desc mb-0 text-wrap">文章归档。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://www.shellio.cc/tags/_index.zh-han/"><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-tagsbi bi-tags hi-svg-inline" fill="currentcolor" height="2em" style="color:green" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M3 2v4.586l7 7L14.586 9l-7-7zM2 2a1 1 0 011-1h4.586a1 1 0 01.707.293l7 7a1 1 0 010 1.414l-4.586 4.586a1 1 0 01-1.414.0l-7-7A1 1 0 012 6.586z"></path><path d="M5.5 5a.5.5.0 110-1 .5.5.0 010 1m0 1a1.5 1.5.0 100-3 1.5 1.5.0 000 3M1 7.086a1 1 0 00.293.707L8.75 15.25l-.043.043a1 1 0 01-1.414.0l-7-7A1 1 0 010 7.586V3a1 1 0 011-1z"></path></svg></div><div class="dropdown-item-content"><div class="dropdown-item-title mb-1">标签</div><p class="dropdown-item-desc mb-0 text-wrap">所有标签。</p></div></a></li></ul></li></ul><ul class="hb-header-panel navbar-nav flex-row flex-wrap"><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><hr class="d-lg-none my-2 text-body-50"/></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href="mailto:andywuwu0728@gmail.com" target="_blank" rel="nofollow me" title="Email"><svg aria-hidden="true" class="bi bi-envelope-fillbi bi-envelope-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M.05 3.555A2 2 0 012 2h12a2 2 0 011.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558zM6.761 8.83.191 12.857A2 2 0 002 14h12a2 2 0 001.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"></path></svg><span class="hb-social-text d-lg-none ms-1">Email</span></a></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href="https://github.com/Andywugh" target="_blank" rel="nofollow me" title="GitHub"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" role="img" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="hb-social-text d-lg-none ms-1">GitHub</span></a></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href="/index.xml" target="_blank" rel="nofollow me" title="RSS"><svg aria-hidden="true" class="bi bi-rss-fillbi bi-rss-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm1.5 2.5c5.523.0 10 4.477 10 10a1 1 0 11-2 0 8 8 0 00-8-8 1 1 0 010-2m0 4a6 6 0 016 6 1 1 0 11-2 0 4 4 0 00-4-4 1 1 0 010-2m.5 7a1.5 1.5.0 110-3 1.5 1.5.0 010 3"></path></svg><span class="hb-social-text d-lg-none ms-1">RSS</span></a></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href="https://www.zhihu.com/people/Andywuwu" target="_blank" rel="nofollow me" title="知乎"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" role="img" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><title>Zhihu</title><path d="M5.721.0C2.251.0.0 2.25.0 5.719V18.28C0 21.751 2.252 24 5.721 24h12.56C21.751 24 24 21.75 24 18.281V5.72C24 2.249 21.75.0 18.281.0zm1.964 4.078c-.271.73-.5 1.434-.68 2.11h4.587c.545-.006.445 1.168.445 1.171H9.384a58.104 58.104.0 01-.112 3.797h2.712c.388.023.393 1.251.393 1.266H9.183a9.223 9.223.0 01-.408 2.102l.757-.604c.452.456 1.512 1.712 1.906 2.177.473.681.063 2.081.063 2.081l-2.794-3.382c-.653 2.518-1.845 3.607-1.845 3.607-.523.468-1.58.82-2.64.516 2.218-1.73 3.44-3.917 3.667-6.497H4.491c0-.015.197-1.243.806-1.266h2.71c.024-.32.086-3.254.086-3.797H6.598c-.136.406-.158.447-.268.753-.594 1.095-1.603 1.122-1.907 1.155.906-1.821 1.416-3.6 1.591-4.064.425-1.124 1.671-1.125 1.671-1.125zM13.078 6h6.377v11.33h-2.573l-2.184 1.373-.401-1.373h-1.219zm1.313 1.219v8.86h.623l.263.937 1.455-.938h1.456v-8.86z"></path></svg><span class="hb-social-text d-lg-none ms-1">知乎</span></a></li><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><div class="vr d-none d-lg-flex h-100 mx-lg-2 text-body"></div><hr class="d-lg-none my-2 text-body-50"/></li><li class="theme-toggle nav-item dropdown col-6 col-lg-auto d-flex flex-column justify-content-center"><button class="btn btn-link btn-theme-toggle nav-link py-2 px-0 px-lg-2 d-flex justify-content-start justify-content-lg-center align-items-center" data-style="switch" aria-expanded="false" title="主题">
<svg aria-hidden="true" class="bi bi-circle-halfbi bi-circle-half hi-svg-inline my-1 theme-toggle-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 108 1zm0 1A8 8 0 118 0a8 8 0 010 16"></path></svg><span class="d-lg-none ms-1 theme-name">主题</span></button><ul class="theme-toggle-menu dropdown-menu dropdown-menu-end"><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name="自动" data-bs-theme-value="auto">
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-circle-halfbi bi-circle-half hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 108 1zm0 1A8 8 0 118 0a8 8 0 010 16"></path></svg></span>自动</button></li><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name="暗色" data-bs-theme-value="dark">
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-moon-starsbi bi-moon-stars hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278M4.858 1.311A7.269 7.269.0 001.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316.0 005.205-2.162c-.337.042-.68.063-1.029.063-4.61.0-8.343-3.714-8.343-8.29.0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span>暗色</button></li><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name="亮色" data-bs-theme-value="light">
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-brightness-highbi bi-brightness-high hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 110-6 3 3 0 010 6m0 1a4 4 0 100-8 4 4 0 000 8M8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0m0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13m8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5M3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8m10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0m-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707M4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"></path></svg></span>亮色</button></li></ul></li></ul></div></div></div></nav></header><div class="hb-main container"><div class="hb-blog-main-container"><div class="hb-blog-main"><div class="container-fluid px-0 mb-4"><nav aria-label="breadcrumb"><ol class="hb-breadcrumb breadcrumb"><li class="breadcrumb-item"><a href="/" title="程序员安仔的技术文档/博客">主页</a></li><li class="breadcrumb-item"><a href="/series/" title="专栏">专栏</a></li><li class="breadcrumb-item active" aria-current="page"><a href="/series/rocketmq/" title="RocketMQ">RocketMQ</a></li></ol></nav></div><div class="hb-blog-term-profile hb-module d-flex flex-column align-items-center"><h1 class="text-center h4 mb-3 mt-2"><a class="text-decoration-none" href="/series/rocketmq/">RocketMQ</a></h1><ul class="nav justify-content-center mt-auto mb-0"><li class="nav-item d-flex flex-column justify-content-center align-items-center my-2 mx-3"><span class="mb-1 fw-bold btn btn-secondary rounded">36</span>
<span class="text-body-secondary">文章</span></li><li class="nav-item d-flex flex-column justify-content-center align-items-center my-2 mx-3"><span class="mb-1 fw-bold btn btn-secondary rounded">1</span>
<span class="text-body-secondary">板块</span></li><li class="nav-item d-flex flex-column justify-content-center align-items-center my-2 mx-3"><span class="mb-1 fw-bold btn btn-secondary rounded">1</span>
<span class="text-body-secondary">类型</span></li></ul></div><div class="hb-terms-posts row row-cols-1 row-cols-md-2"><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">10 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/9/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="九、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-上篇" href="/docs/mq/rocketmq-advanced/9/">九、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-上篇</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">RocketMQ 存储基础回顾： 源码分析RocketMQ之CommitLog消息存储机制
本文主要从源码的角度分析 Rocketmq 消费队列 ConsumeQueue 物理文件的构建与存储结构，同时分析 RocketMQ 索引文件IndexFile 文件的存储原理、存储格式以及检索方式。RocketMQ 的存储机制是所有的主题消息都存储在 CommitLog 文件中，也就是消息发送是完全的顺序 IO 操作，加上利用内存文件映射机制，极大的提供的 IO 性能。消息的全量信息存放在 commitlog 文件中，并且每条消息的长度是不一样的，消息的具体存储格式如下：
如果消费者直接基于commitlog 进行消费的话，简直就是一个恶梦，因为不同的主题的消息完全顺序的存储在 commitlog 文件中，根据主题去查询消息，不得不遍历整个 commitlog 文件，显然作为一款消息中间件这是绝不允许的。RocketMQ 的ConsumeQueue 文件就是来解决消息消费的。首先我们知道，一个主题，在 broker 上可以分成多个消费对列，默认为4个，也就是消费队列是基于主题+broker。那 ConsumeQueue 中当然不会再存储全量消息了，而是存储为定长（20字节，8字节commitlog 偏移量+4字节消息长度+8字节tag hashcode）,消息消费时，首先根据 commitlog offset 去 commitlog 文件组（commitlog每个文件1G，填满了，另外创建一个文件），找到消息的起始位置，然后根据消息长度，读取整条消息。但问题又来了，如果我们需要根据消息ID，来查找消息，consumequeue 中没有存储消息ID,如果不采取其他措施，又得遍历 commitlog文件了，为了解决这个问题，rocketmq 的 index 文件又派上了用场。
接下来，本文重点关注 ConsumeQueue、Index 文件是如何基于 Commitlog 构建的，并且根据 ConsumeQueue、Index 文件如何查找消息。
根据commitlog 文件生成 consumequeue、index 文件，主要同运作于两种情况：
1、 运行中，发送端发送消息到commitlog文件，此时如何及时传达到consume文件、Index文件呢？；
2、 broker启动时，检测commitlog文件与consumequeue、index文件中信息是否一致，如果不一致，需要根据commitlog文件重新恢复consumequeue文件和index文件；
1、commitlog、consumequeue、index 文件同步问题 RocketMQ 采用专门的线程来根据 comitlog offset 来将 commitlog 转发给ConsumeQueue、Index。其线程为DefaultMessageStore$ReputMessageService
1.1 核心属性 private volatile long reputFromOffset = 0</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/9/">阅读更多关于九、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-上篇的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">1 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/6/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="六、RocketMQ源码分析消息消费机制—-消费端消息负载均衡机制与重新分布" href="/docs/mq/rocketmq-advanced/6/">六、RocketMQ源码分析消息消费机制—-消费端消息负载均衡机制与重新分布</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">1、消息消费需要解决的问题 首先再次重复啰嗦一下 RocketMQ 消息消费的一些基本元素的关系
主题—》 消息队列(MessageQueue) 1 对多。
主题—》 消息生产者，一般主题会由多个生产者组成，生产者组。
主题—》 消息消费者，一般一个主题也会被多个消费者消费。
那消息消费至少需要解决如下问题：
1、 一个消费组中多个消费者是如何对消息队列（1个主题多个消息队列）进行负载消费的；
2、 一个消费者中多个线程又是如何协作（并发）的消费分配给该消费者的消息队列中的消息呢？；
3、 消息消费进度如何保存，包括MQ是如何知道消息是否正常被消费了；
4、 RocketMQ推拉模式实现机制；
再提一个业界关于消费者与消息队列的消费规则。
1个消费者可以消费多个消息队列，但一个消息队列同一时间只能被一个消费者消费，这又是如何实现的呢？
本文紧接着上文：消息消费概述 。
继续探讨消息分发与消费端负载均衡。
我们从上文知道，PullMessageService 线程主要是负责 pullRequestQueue 中的 PullResult，那问题来了，pullRequestQueue 中的数据从哪来，在什么时候由谁来填充呢。
那我们就先沿着这条线索分析下去，看一下 PullMessageService 的 pullReqestQueue 添加元素的方法的调用链条如下：
也就是调用链：
1RebalanceService. run() 2MQClientInstance.doRebalance() 3DefaultMQPulConsumerImpl.doRebalance() 4RebalanceImpl.doRebalance() 5RebalanceImpl.rebalanceByTopic 6RebalanceImpl.updateProcessQueueTableInRebalance 7RebalanceImpl.dispatchPullRequest 8DefaultMQPushConsumerImpl.executePullRequestImmediately 从上面可以直观的看出，向 PullMesssageService 的 LinkedBlockingQueue pullRequestQueue 添加 PullRequest的是 RebalanceService.run 方法，就是向 PullMessageService 中放入 PullRequest,才会驱动 PullMessageSerivce run方法的运行，如果 pullRequestQueue 中没有元素，PullMessageService 线程将被阻塞。
那么RebalanceService是何许人也，让我们一起来揭开其神秘面纱。
2、消息消费负载机制分析 2.1 RebalanceService 线程 从上面可以看出，MQClientInstance 持有一个 RebalanceService 线程并启动它。RebalanceService 线程的 run 方法比较简单，就是直接调用 mqClientFactory.</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/6/">阅读更多关于六、RocketMQ源码分析消息消费机制—-消费端消息负载均衡机制与重新分布的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">2 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/7/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="七、RocketMQ源码分析之消息消费重试机制" href="/docs/mq/rocketmq-advanced/7/">七、RocketMQ源码分析之消息消费重试机制</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">主要关注业务方在消息消费失败后，返回 ConsumeConcurrentlyStatus.RECONSUME_LATER ,专业术语：业务方每条消息消费后要告诉 MQ 消费者一个结果(ack,message back)，触发 MQ 消息消费重试机制，然后 MQ 消费者需要反馈给 MQ(Broker)。
备注：主要针对的还是非顺序消息，顺序消息在后续专题详细分析。
1、消息消费处理 代码入口：ConsumeMessageConcurrentlyService ConsumeRequest run方法
然后进入到结果处理：ConsumeMessageConcurrentlyService processConsumeResult
如果返回结果是 CONSUME_SUCCESS，此时 ackIndex = msg.size() – 1,再看发送 sendMessageBack 循环的条件，for (int i = ackIndex + 1; i &lt; msg.size() ;;) 从这里可以看出如果消息成功，则无需发送sendMsgBack 给 broker。
如果返回结果是 RECONSUME_LATER， 此时 ackIndex = -1 ，则这批所有的消息都会发送消息给Broker,也就是这一批消息都得重新消费。如果发送 ack 失败，则会延迟5s后重新在消费端重新消费。
消费者向 Broker 发送 ACK 消息，如果发送成功，重试机制由 broker 处理，如果发送 ack 消息失败，则将该任务直接在消费者这边，再次在本地处理该批消息，默认演出5s后在消费者重新消费,其关键总结如下：
根据消费结果，设置ackIndex 的值 如果是消费失败，根据消费模式（集群消费还是广播消费），广播模式，直接丢弃，集群模式发送 sendMessageBack。 更新消息消费进度，不管消费成功与否，上述这些消息消费成功，其实就是修改消费偏移量。（失败的，会进行重试，会创建新的消息)。 然后我们重点跟踪 sendMessageBack 方法：
DefaultMQPushConsumerImpl sendMessageBack
核心实现要点如下：</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/7/">阅读更多关于七、RocketMQ源码分析之消息消费重试机制的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">13 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/3/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三、RocketMQ源码分析之CommitLog消息存储机制" href="/docs/mq/rocketmq-advanced/3/">三、RocketMQ源码分析之CommitLog消息存储机制</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">本文重点分析 Broker 接收到生产者发送消息请求后如何存储在 Broker 上，本文暂不关注事务消息机制。
本文前置篇:RocketMQ源码分析之Broker概述与同步消息发送原理与高可用设计及思考 。
RocketMQ 的存储核心类为 DefaultMessageStore,存储消息的入口方法为：putMessage。
在深入学习消息存储之前，我们先大概了解一下DefaultMessageStore的属性与构造方法。
1、消息存储分析 1.1 DefaultMessageStore 概要 其核心属性如下：
messageStoreConfig
存储相关的配置，例如存储路径、commitLog文件大小，刷盘频次等等。 CommitLog commitLog
comitLog 的核心处理类，消息存储在 commitlog 文件中。 ConcurrentMap&lt;String/\* topic \*/, ConcurrentMap&lt;Integer/* queueId */, ConsumeQueue»` consumeQueueTable
topic 的队列信息。 FlushConsumeQueueService flushConsumeQueueService
ConsumeQueue 刷盘服务线程。 CleanCommitLogService cleanCommitLogService
commitLog 过期文件删除线程。 CleanConsumeQueueService cleanConsumeQueueService
consumeQueue 过期文件删除线程。、 IndexService indexService
索引服务。 AllocateMappedFileService allocateMappedFileService
MappedFile 分配线程，RocketMQ 使用内存映射处理 commitlog、consumeQueue文件。 ReputMessageService reputMessageService
reput 转发线程（负责 Commitlog 转发到 Consumequeue、Index文件）。 HAService haService
主从同步实现服务。 ScheduleMessageService scheduleMessageService
定时任务调度器，执行定时任务。 StoreStatsService storeStatsService</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/3/">阅读更多关于三、RocketMQ源码分析之CommitLog消息存储机制的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">1 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/30/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十、RocketMQ消息轨迹-设计篇" href="/docs/mq/rocketmq-advanced/30/">三十、RocketMQ消息轨迹-设计篇</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">本节目录 1、消息轨迹数据格式 2、 记录消息轨迹；
3、 如何存储消息轨迹数据；
RocketMQ消息轨迹主要包含两篇文章：设计篇与源码分析篇，本节将详细介绍RocketMQ消息轨迹-设计相关。
RocketMQ消息轨迹，主要跟踪消息发送、消息消费的轨迹，即详细记录消息各个处理环节的日志，从设计上至少需要解决如下三个核心问题：
消费轨迹数据格式 记录消息轨迹(消息日志) 消息轨迹数据存储在哪？ 1、消息轨迹数据格式 RocketMQ4.5版本消息轨迹主要记录如下信息：
traceType
跟踪类型，可选值：Pub(消息发送)、SubBefore(消息拉取到客户端，执行业务定义的消费逻辑之前)、SubAfter(消费后)。 timeStamp
当前时间戳。 regionId
broker所在的区域ID，取自BrokerConfig#regionId。 groupName
组名称，traceType为Pub时为生产者组的名称；如果traceType为subBefore或subAfter时为消费组名称。 requestId
traceType为subBefore、subAfter时使用，消费端的请求Id。 topic
消息主题。 msgId
消息唯一ID。 tags
消息tag。 keys
消息索引key，根据该key可快速检索消息。 storeHost
跟踪类型为PUB时为存储该消息的Broker服务器IP；跟踪类型为subBefore、subAfter时为消费者IP。 bodyLength
消息体的长度。 costTime
耗时。 msgType
消息的类型，可选值：Normal_Msg(普通消息),Trans_Msg_Half(预提交消息),Trans_msg_Commit(提交消息),Delay_Msg(延迟消息)。 offsetMsgId
消息偏移量ID,该ID中包含了broker的ip以及偏移量。 success
是发送成功。 contextCode
消费状态码，可选值：SUCCESS,TIME_OUT,EXCEPTION,RETURNNULL,FAILED。 2、记录消息轨迹 因初次访问，为防止爬虫和人机识别，请关注微信公众号，回复:‘验证码‘获取验证码来解锁全文 解锁内容 消息中间件的两大核心主题：消息发送、消息消费，其核心载体就是消息，消息轨迹（消息的流转）主要是记录消息是何时发送到哪台Broker，发送耗时多少时间，在什么是被哪个消费者消费。记录消息的轨迹主要是集中在消息发送前后、消息消费前后，可以通过RokcetMQ的Hook机制。通过如下两个接口来定义钩子函数。
通过实行上述两个接口，可以实现在消息发送、消息消费前后记录消息轨迹，为了不明显增加消息发送与消息消费的时延，记录消息轨迹最好使用异步发送模式。
3、如何存储消息轨迹数据 消息轨迹需要存储什么消息以及在什么时候记录消息轨迹的问题都以及解决，那接下来就得思考将消息轨迹存储在哪里？存储在数据库中或其他媒介中，都会加重消息中间件，使其依赖外部组件，最佳的选择还是存储在Broker服务器中，将消息轨迹数据也当成一条消息存储到Broker服务器。
既然把消息轨迹当成消息存储在Broker服务器，那存储消息轨迹的Topic如何确定呢？RocketMQ提供了两种方法来定义消息轨迹的Topic。
系统默认Topic
如果Broker的traceTopicEnable配置设置为true，表示在该Broker上创建topic名为：RMQ_SYS_TRACE_TOPIC，队列个数为1，默认该值为false，表示该Broker不承载系统自定义用于存储消息轨迹的topic。 自定义Topic
在创建消息生产者或消息消费者时，可以通过参数自定义用于记录消息轨迹的Topic名称，不过要注意的是，rokcetmq控制台(rocketmq-console)中只支持配置一个消息轨迹Topic，故自定义Topic，在目前这个阶段或许还不是一个最佳实践，建议使用系统默认的Topic即可。 通常为了避免消息轨迹的数据与正常的业务数据混合在一起，官方建议，在Broker集群中，新增加一台机器，只在这台机器上开启消息轨迹跟踪，这样该集群内的消息轨迹数据只会发送到这一台Broker服务器上，并不会增加集群内原先业务Broker的负载压力。
RocketMQ消息轨迹的设计细节就介绍到这里了，下一篇将从源码的角度对其实现细节进行详细的剖析；如果觉得本文对您有帮助的话，期待您的点赞，谢谢。</div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">4 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/32/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十二、RocketMQ一个新的消费组初次启动时从何处开始消费呢？" href="/docs/mq/rocketmq-advanced/32/">三十二、RocketMQ一个新的消费组初次启动时从何处开始消费呢？</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">本文目录 1、抛出问题
1.1 环境准备
1.2 消息发送者代码
1.3 消费端验证代码
2、 探究CONSUME_FROM_MAX_OFFSET实现原理；
2.1 CONSUME_FROM_LAST_OFFSET计算逻辑 2.2 CONSUME_FROM_FIRST_OFFSET 2.4 CONSUME_FROM_TIMESTAMP 3、 猜想与验证；
4、 解决方案；
1、抛出问题 一个新的消费组订阅一个已存在的Topic主题时，消费组是从该Topic的哪条消息开始消费呢？
首先翻阅DefaultMQPushConsumer的API时，setConsumeFromWhere(ConsumeFromWhere consumeFromWhere)API映入眼帘，从字面意思来看是设置消费者从哪里开始消费，正是解开该问题的”钥匙“。ConsumeFromWhere枚举类图如下：
CONSUME_FROM_MAX_OFFSET
从消费队列最大的偏移量开始消费。 CONSUME_FROM_FIRST_OFFSET
从消费队列最小偏移量开始消费。 CONSUME_FROM_TIMESTAMP
从指定的时间戳开始消费，默认为消费者启动之前的30分钟处开始消费。可以通过DefaultMQPushConsumer#setConsumeTimestamp。 是不是点小激动，还不快试试。
需求：新的消费组启动时，从队列最后开始消费，即只消费启动后发送到消息服务器后的最新消息。
1.1 环境准备 本示例所用到的Topic路由信息如下：
Broker的配置如下(broker.conf)
1brokerClusterName = DefaultCluster 2brokerName = broker-a 3brokerId = 0 4deleteWhen = 04 5fileReservedTime = 48 6brokerRole = ASYNC_MASTER 7flushDiskType = ASYNC_FLUSH 8storePathRootDir=E:/SH2019/tmp/rocketmq_home/rocketmq4.5_simple/store 9storePathCommitLog=E:/SH2019/tmp/rocketmq_home/rocketmq4.5_simple/store/commitlog 10namesrvAddr=127.0.0.1:9876 11autoCreateTopicEnable=false 12mapedFileSizeCommitLog=10240 13mapedFileSizeConsumeQueue=2000 其中重点修改了如下两个参数：
mapedFileSizeCommitLog
单个commitlog文件的大小，这里使用10M，方便测试用。 mapedFileSizeConsumeQueue
单个consumequeue队列长度，这里使用1000，表示一个consumequeue文件中包含1000个条目。 1.2 消息发送者代码 1public static void main(String[] args) throws MQClientException, InterruptedException { 2 DefaultMQProducer producer = new DefaultMQProducer(&#34;please_rename_unique_group_name&#34;); 3 producer.</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/32/">阅读更多关于三十二、RocketMQ一个新的消费组初次启动时从何处开始消费呢？的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">1 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/36/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十六、RocketMQ 主题扩分片后遇到的坑" href="/docs/mq/rocketmq-advanced/36/">三十六、RocketMQ 主题扩分片后遇到的坑</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">消息组接到某项目组反馈，topic 在扩容后出现部分队列无法被消费者，导致消息积压，影响线上业务？
考虑到该问题是发送在真实的线上环境，为了避免泄密，本文先在笔者的虚拟机中来重现问题。
本节目录 1、 案情回顾；
1.1 集群现状 1.2、RocketMQ 在线扩容队列 1.3 消息发送 2、 问题暴露；
3、 问题分析；
4、 问题复盘；
1、案情回顾 1.1 集群现状 集群信息如下：
例如业务主体名 topic_dw_test_by_order_01 的路由信息如图所示：
当前的消费者信息：
broker 的配置信息如下：
1brokerClusterName = DefaultCluster 2brokerName = broker-a 3brokerId = 0 4deleteWhen = 04 5fileReservedTime = 48 6brokerRole = ASYNC_MASTER 7flushDiskType = ASYNC_FLUSH 8brokerIP1=192.168.0.220 9brokerIP2-192.168.0.220 10namesrvAddr=192.168.0.221:9876;192.168.0.220:9876 11storePathRootDir=/opt/application/rocketmq-all-4.5.2-bin-release/store 12storePathCommitLog=/opt/application/rocketmq-all-4.5.2-bin-release/store/commitlog 13autoCreateTopicEnable=false 14autoCreateSubscriptionGroup=false 备注：公司对 topic、消费组进行了严格的管控，项目组需要使用时需要向运维人员申请，故 broker 集群不允许自动创建主题与自动创建消费组。
由于该业务量稳步提升，项目组觉得该主题的队列数太少，不利于增加消费者来提高其消费能力，故向运维人员提出增加队列的需求。
1.2、RocketMQ 在线扩容队列 运维通过公司自研的消息运维平台，直接以指定集群的方式为 topic 扩容，该运维平台底层其实使用了RocketMQ 提供的 updateTopic 命令，其命令说明如下：</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/36/">阅读更多关于三十六、RocketMQ 主题扩分片后遇到的坑的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">1 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/33/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十三、RocketMQ 多副本前置篇：初探raft协议" href="/docs/mq/rocketmq-advanced/33/">三十三、RocketMQ 多副本前置篇：初探raft协议</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">Raft协议是分布式领域解决一致性的又一著名协议，主要包含Leader选举、日志复制两个部分。
温馨提示：
本文根据raft官方给出的raft动画进行学习，其动画展示地址：http://thesecretlivesofdata.com/raft/
本节目录 1、Leader选举
1.1 一轮投票中，只有一个节点发起投票的情况
1.2 一轮投票中，超过一个节点发起投票的情况
1.3 思考如何实现Raft选主
2、 日志复制；
1、Leader选举 1.1 一轮投票中，只有一个节点发起投票的情况 Raft协议中节点有3种状态（角色）：
Follower
跟随者。 Candidate
候选者。 Leader
领导者(Leader)，通常我们所说的的主节点。 首先3个节点初始状态为 Follower，每个节点会有一个超时时间(计时器)，其时间设置为150ms~300ms之间的随机值。当计时器到期后，节点状态从 Follower 变成 Candidate，如下图所示：
通常情况下，三个节点中会有一个节点的计时器率先到期，节点状态变为 Candidate ，候选者状态下的节点会发起选举投票。我们先来考虑只有一个节点变为Candidate时是如何进行选主的。
当节点状态为Candidate，将发起一轮投票，由于是第一轮投票，设置本轮投票轮次为1，并首先为自己投上一票，正如上图所示的NodeA节点，Team为1，Vote Count为1.
当一个节点的定时器超时后，首先为自己投上一票，然后向该组内其他的节点发起投票(用拉票更加合适)，发送投票请求。
当集群内的节点收到投票请求外，如果本轮未进行过投票，则赞同，否则反对，然后将结果返回，并重置计时器。
当节点A收到的赞同票大于一半时，则升级为该集群的 Leader，然后定时向集群内的其他节点发送心跳，以便确定自己的领导地位，正如下图所示。
Node A，集群中的 Leader正在向其他节点发送心跳包。
节点在收到 Leader 的心跳包后，返回响应结果，并重置自身的计时器，如果 Flower 状态的节点在计时时间超时内没有收到Leader 的心跳包，就会从 Flower 节点变成 Candidate,该节点就会发起下一轮投票。
例如NodeA节点宕机，停止向它的从发送心跳，我们来看一下集群如何重新选主。
如果主节点宕机，则停止向集群内的节点发送心跳包。随着计时器的到期，节点B的先于节点C变成 Candidate，则节点B向集群内的其他节点发起投票，如下图所示。
节点B，首先将投票轮次设置为2，然后首先为自己投上一篇，然后向其他节点发起投票请求。
节点C收到请求，由于其投票轮次大于自己的投票轮次，并该轮次并未投票，投出赞成票并返回结果，然后重置计时器。节点B将顺理成章的成为新的Leader并定时发送心跳包。
3个节点的选主就介绍到这里了，也许有网友会说，虽然各个节点的计时器是随机的，但也有可能同一时间，或一个节点在未收到另一个节点发起的投票请求之前变成 Candidate，即在一轮投票过程中，有大于1个的节点状态都是 Candidate，那该如何选主呢？
下面以4个节点的集群为例，来阐述上述这种情况情况下，如何进行选主。
1.2 一轮投票中，超过一个节点发起投票的情况 首先同时有两个节点进入Candidate状态，并开始新的一轮投票，当前投票编号为4，首先先为自己投上一票，然后向集群中的其他节点发起投票，如下图所示：
然后各个节点收到投票请求，如下所示，进行投票：
首先节点C、D在收到D、C节点的投票请求时，都会返回不同意，因为在本轮投票中，已经各自为自己投了一票，按照上图，节点A同意C节点、节点B同意D节点，那此时C、D都只获的两票，当然如果A,B都认为C或D成为主节点，则选择就可以结束了，上图显示，C、D都只获的2票，未超过半数，无法成为主节点，那接下来会发生什么呢？请看下图：
此时A,B,C,D的定时器各自在倒计时，当节点成为Candidate时，或自身状态本身是Candidate并且定时器触发后，发起一轮新的投票，图中是节点B、节点D同时发起了新的一轮投票。
投票结果如下：节点A,节点C同意节点B成为leader，但由于BD都发起了第5轮投票，最终的投票轮次更新为6，如图所示：
关于Raft协议的选主就介绍到这里了，接下来我们来思考一下，如果自己实现 Raf t协议，至少要考虑哪些问题，为下一篇源码阅读Dleger(RocketMQ多副本)模块提供一些思路。
1.3 思考如何实现Raft选主 1、 节点状态；</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/33/">阅读更多关于三十三、RocketMQ 多副本前置篇：初探raft协议的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">9 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/34/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十四、源码分析 RocketMQ DLedger 多副本之 Leader 选主" href="/docs/mq/rocketmq-advanced/34/">三十四、源码分析 RocketMQ DLedger 多副本之 Leader 选主</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">温馨提示：《RocketMQ技术内幕》作者倾力打造的全新专栏：RocketMQ 多副本(主从切换)：
1、《RocketMQ 多副本前置篇：初探raft协议》
本文将按照《RocketMQ 多副本前置篇：初探raft协议》的思路来学习RocketMQ选主逻辑。首先先回顾一下关于Leader的一些思考：
1、 节点状态；
需要引入3种节点状态：Follower(跟随者)、Candidate(候选者)，该状态下的节点会发起投票请求，Leader(主节点)。
2、 选举计时器；
Follower、Candidate两个状态时，需要维护一个定时器，每次定时时间从150ms-300ms直接进行随机，即每个节点的定时过期不一样，Follower状态时，定时器到点后，触发一轮投票。节点在收到投票请求、Leader的心跳请求并作出响应后，需要重置定时器。
3、 投票轮次Team；
Candidate状态的节点，每发起一轮投票，Team加一。
4、 投票机制；
每一轮一个节点只能为一个节点投赞成票，例如节点A中维护的轮次为3，并且已经为节点B投了赞成票，如果收到其他节点，投票轮次为3，则会投反对票，如果收到轮次为4的节点，是又可以投赞成票的。
5、 成为Leader的条件；
必须得到集群中初始数量的大多数，例如如果集群中有3台，则必须得到两票，如果其中一台服务器宕机，剩下的两个节点，还能进行选主吗？答案是可以的，因为可以得到2票，超过初始集群中3的一半，所以通常集群中的机器各位尽量为奇数，因为4台的可用性与3台的一样。
温馨提示：本文是从源码的角度分析 DLedger 选主实现原理，可能比较鼓噪，文末给出了选主流程图。
本节目录 1、DLedger关于选主的核心类图
1.1 DLedgerConfig
1.2 MemberState
1.3 raft协议相关
1.3.1 DLedgerClientProtocol
1.3.2 DLedgerProtocol
1.3.3 协议处理Handler
1.4 DLedgerRpcService
1.5 DLedgerLeaderElector
1.6 DLedgerServer
2、 源码分析Leader选举；
2.1 DLedgerLeaderElector 类图
2.2 启动选举状态管理器
2.3 选举状态机状态流转
2.3.1 maintainAsCandidate 方法
2.3.2 maintainAsLeader 方法
2.3.3 maintainAsFollower方法
2.4 投票与投票请求
2.4.1 voteForQuorumResponses
2.4.2 handleVote 方法
2.5 心跳包与心跳包响应</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/34/">阅读更多关于三十四、源码分析 RocketMQ DLedger 多副本之 Leader 选主的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">3 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/35/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十五、源码分析 RocketMQ DLedger 多副本存储实现" href="/docs/mq/rocketmq-advanced/35/">三十五、源码分析 RocketMQ DLedger 多副本存储实现</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">本节目录 1、 DLedger存储相关类图；
1.1 DLedgerStore 1.2 DLedgerMemoryStore 1.3 DLedgerMmapFileStore 2、 DLedger存储对标RocketMQ存储；
3、 DLedger数据存储格式；
4、 DLedger索引存储格式；
5、 思考；
RocketMQ DLedger 的存储实现思路与 RocketMQ 的存储实现思路相似，本文就不再从源码角度详细剖析其实现，只是点出其实现关键点。我们不妨简单回顾一下 CommitLog 文件、ConsumeQueue 文件设计思想。
其文件组成形式如下：
正如上图所示，多个 commitlog 文件组成一个逻辑上的连续文件，使用 MappedFileQueue 表示，单个 commitlog 文件使用 MappedFile 表示。
温馨提示：如果想详细了解 RocketMQ 关于存储部分的讲解，可以关注笔者的《RocketMQ 技术内幕》一书。
1、DLedger 存储相关类图 1.1 DLedgerStore 存储抽象类，定义如下核心方法：
public abstract DLedgerEntry appendAsLeader(DLedgerEntry entry)
向主节点追加日志(数据)。 public abstract DLedgerEntry appendAsFollower(DLedgerEntry entry, long leaderTerm, String leaderId)
向从节点同步日志。 public abstract DLedgerEntry get(Long index)
根据日志下标查找日志。 public abstract long getCommittedIndex()</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/35/">阅读更多关于三十五、源码分析 RocketMQ DLedger 多副本存储实现的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">6 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/31/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="三十一、RocketMQ源码分析消息轨迹" href="/docs/mq/rocketmq-advanced/31/">三十一、RocketMQ源码分析消息轨迹</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">本文沿着《RocketMQ消息轨迹-设计篇》的思路，从如下3个方面对其源码进行解读：
1、 发送消息轨迹；
2、 消息轨迹格式；
3、 存储消息轨迹数据；
本节目录 1、发送消息轨迹流程
1.1 DefaultMQProducer构造函数
1.2 SendMessageTraceHookImpl钩子函数
1.2.1 SendMessageTraceHookImpl类图
1.2.2 源码分析SendMessageTraceHookImpl
1.2.2.1 sendMessageBefore 1.2.2.2 sendMessageAfter 1.3 TraceDispatcher实现原理
1.3.1 TraceDispatcher构造函数
1.3.2 getAndCreateTraceProducer详解
1.3.3 start
1.3.4 AsyncRunnable
1.3.5 AsyncAppenderRequest\#sendTraceData 1.3.6 TraceDataEncoder\#encoderFromContextBean 1.3.6.1 PUB(消息发送) 1.3.6.2 SubBefore(消息消费之前) 1.3.2.3 SubAfter（消息消费后） 2、 消息轨迹数据如何存储；
2.1 使用系统默认的主题名称 2.2 用户自定义消息轨迹主题 1、发送消息轨迹流程 首先我们来看一下在消息发送端如何启用消息轨迹，示例代码如下：
1public class TraceProducer { 2 public static void main(String[] args) throws MQClientException, InterruptedException { 3 DefaultMQProducer producer = new DefaultMQProducer(&#34;ProducerGroupName&#34;,true); // @1 4 producer.</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/31/">阅读更多关于三十一、RocketMQ源码分析消息轨迹的内容。</a></div></div></div></div><div class="mb-3 mb-lg-4"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 hb-module mb-0"><div class="hb-blog-post-meta d-flex align-items-center"><a class="hb-blog-post-author-link text-decoration-none" href="/authors/andywu/" title="安图新"><picture><img class="hb-blog-author-img rounded-circle" src="https://assets.hotmindshare.com/public%2Fandyng_1000x1000.png" alt="安图新" loading="lazy"/>
</picture></a><span class="hb-blog-post-date">2023年10月21日</span>
<span class="hb-blog-post-reading-time">6 分钟阅读</span>
<span class="hb-blog-post-section"><a class="badge bg-secondary text-decoration-none fw-normal" href="/docs/">系列教程</a></span></div><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/mq/rocketmq-advanced/10/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="十、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-下篇" href="/docs/mq/rocketmq-advanced/10/">十、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-下篇</a></div><div class="hb-blog-post-meta d-block text-nowrap text-truncate mb-2"><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
</span><span class="hb-blog-post-taxonomy-meta"><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-series badge bg-secondary text-decoration-none fw-normal me-1" href="/series/rocketmq/">RocketMQ</a></span></div><div class="hb-blog-post-summary card-text text-secondary mb-auto">上篇主要是讲解 RocketMQ 运行过程中消息发送者发送一条消息，进入到 commitlog 文件,然后是如何被转发到consumequeue、index索引文件中的，本节主要剖析一下，在 RocketMQ 启动过程中，是如何根据 commitlog 重构consumeque,index的，因为毕竟 commitlog 文件中的消息与 consumequeue 中的文件内容并不能确保是一致的。
入口：DefaultMessageStore#load
1/** 2 * @throws IOException 3 */ 4 public boolean load() { 5 boolean result = true; 6 try { 7 boolean lastExitOK = !this.isTempFileExist(); // @1 8 log.info(&#34;last shutdown {}&#34;, lastExitOK ? &#34;normally&#34; : &#34;abnormally&#34;); 9 if (null != scheduleMessageService) { 10 result = result &amp;&amp; this.scheduleMessageService.load(); // @2 11 } 12 // load Commit Log 13 result = result &amp;&amp; this.</div><div class="mt-2"><a class="text-secondary" href="/docs/mq/rocketmq-advanced/10/">阅读更多关于十、RocketMQ源码分析之消费队列、Index索引文件存储结构与存储机制-下篇的内容。</a></div></div></div></div></div><nav class="hb-blog-pagination mb-3" aria-label="Page navigation"><ul class="pagination flex-wrap justify-content-center"><li class="page-item"><a class="page-link" href="/series/rocketmq/" aria-label="前一页"><span aria-hidden="true">«</span></a></li><li class="page-item"><a class="page-link" href="/series/rocketmq/">1</a></li><li class="page-item active"><a class="page-link" href="/series/rocketmq/page/2/">2</a></li><li class="page-item"><a class="page-link" href="/series/rocketmq/page/3/">3</a></li><li class="page-item"><a class="page-link" href="/series/rocketmq/page/3/" aria-label="下一页"><span aria-hidden="true">»</span></a></li></ul></nav></div><div class="hb-blog-sidebar pe-lg-1"><div class="hb-blog-sidebar-profile hb-module d-flex flex-column justify-content-center align-items-center"><picture><source srcset="/images/logo_hu3f5eb531558986e612421c7146e04118_941594_c6864c8867b5b1d8c1d896794c52a337.webp" type="image/webp"/><img class="hb-blog-sidebar-profile-img rounded-circle img-fluid mb-3" src="https://www.shellio.cc/images/logo_hu3f5eb531558986e612421c7146e04118_941594_100x0_resize_box_3.0ce64b16d51294ec773c81921b7cc652.png" alt="" loading="lazy" height="100" width="100"/></picture><p class="hb-blog-sidebar-profile-title text-center h5 mb-2">程序员安仔</p><p class="hb-blog-sidebar-profile-desc text-center mb-2">一个只爱折腾技术的普通人</p><p class="hb-blog-sidebar-profile-meta mb-0"></p><div class="hb-footer-socials d-flex mb-0 mt-1 justify-content-center"><a class="hb-social p-2" href="mailto:andywuwu0728@gmail.com" target="_blank" rel="nofollow me" title="Email"><svg aria-hidden="true" class="bi bi-envelope-fillbi bi-envelope-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" style="color:%!s(bool=true)" viewBox="0 0 16 16" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M.05 3.555A2 2 0 012 2h12a2 2 0 011.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558zM6.761 8.83.191 12.857A2 2 0 002 14h12a2 2 0 001.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"></path></svg></a><a class="hb-social p-2" href="https://github.com/Andywugh" target="_blank" rel="nofollow me" title="GitHub"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" role="img" style="color:%!s(bool=true)" viewBox="0 0 24 24" width="1.75em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="hb-social p-2" href="/index.xml" target="_blank" rel="nofollow me" title="RSS"><svg aria-hidden="true" class="bi bi-rss-fillbi bi-rss-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" style="color:%!s(bool=true)" viewBox="0 0 16 16" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm1.5 2.5c5.523.0 10 4.477 10 10a1 1 0 11-2 0 8 8 0 00-8-8 1 1 0 010-2m0 4a6 6 0 016 6 1 1 0 11-2 0 4 4 0 00-4-4 1 1 0 010-2m.5 7a1.5 1.5.0 110-3 1.5 1.5.0 010 3"></path></svg></a><a class="hb-social p-2" href="https://www.zhihu.com/people/Andywuwu" target="_blank" rel="nofollow me" title="知乎"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" role="img" style="color:#056de8" viewBox="0 0 24 24" width="1.75em" xmlns="http://www.w3.org/2000/svg"><title>Zhihu</title><path d="M5.721.0C2.251.0.0 2.25.0 5.719V18.28C0 21.751 2.252 24 5.721 24h12.56C21.751 24 24 21.75 24 18.281V5.72C24 2.249 21.75.0 18.281.0zm1.964 4.078c-.271.73-.5 1.434-.68 2.11h4.587c.545-.006.445 1.168.445 1.171H9.384a58.104 58.104.0 01-.112 3.797h2.712c.388.023.393 1.251.393 1.266H9.183a9.223 9.223.0 01-.408 2.102l.757-.604c.452.456 1.512 1.712 1.906 2.177.473.681.063 2.081.063 2.081l-2.794-3.382c-.653 2.518-1.845 3.607-1.845 3.607-.523.468-1.58.82-2.64.516 2.218-1.73 3.44-3.917 3.667-6.497H4.491c0-.015.197-1.243.806-1.266h2.71c.024-.32.086-3.254.086-3.797H6.598c-.136.406-.158.447-.268.753-.594 1.095-1.603 1.122-1.907 1.155.906-1.821 1.416-3.6 1.591-4.064.425-1.124 1.671-1.125 1.671-1.125zM13.078 6h6.377v11.33h-2.573l-2.184 1.373-.401-1.373h-1.219zm1.313 1.219v8.86h.623l.263.937 1.455-.938h1.456v-8.86z"></path></svg></a></div></div><div style="padding-bottom:1px"><nav style="margin-bottom:1px;display:flex;flex-direction:column"><div style="float:left;text-align:center!important"><img style="width:110apx;height:110px" src="https://assets.hotmindshare.com/public%2Fmy_QR_Code.jpg" alt="关注我们" title="关注公众号"/></div><p style="font-size:11px;float:left;margin-top:8px;text-align:center!important"><span style="line-height:1.8"><span style="rgb(161,182,226)89color:); font-size: 15px; letter-spacing: 3px; line-height: 0">关注微信公众号</span><br/><span style="rgb(161,182,226)89color:); font-weight: 300; line-height: 1; font-size: 14px"><b>获取更多技术干货和资料</b><br/></span><br/></span></p></nav></div><div class="hb-blog-sidebar-posts hb-module"><ul class="nav nav-pills nav-fill" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="recent-posts-tab" data-bs-toggle="tab" data-bs-target="#recent-posts" type="button" role="tab" aria-controls="recent-posts" aria-selected="true">
最近文章</button></li></ul><div class="tab-content mt-2"><div class="tab-pane slide active" id="recent-posts" role="tabpanel" aria-labelledby="recent-posts-tab" tabindex="0"><div class="slide"><div class="slide-inner row row-cols-1"><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/java/sprintboot2/1/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="一起来学 SpringBoot 2.x | 第一篇：构建第一个 SpringBoot 工程" href="/docs/java/sprintboot2/1/">一起来学 SpringBoot 2.x | 第一篇：构建第一个 SpringBoot 工程</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/java/sprintboot2/5/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="一起来学 SpringBoot 2.x | 第五篇：使用 JdbcTemplate 访问数据库" href="/docs/java/sprintboot2/5/">一起来学 SpringBoot 2.x | 第五篇：使用 JdbcTemplate 访问数据库</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/java/sprintboot2/4/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="一起来学 SpringBoot 2.x | 第四篇：整合Thymeleaf模板" href="/docs/java/sprintboot2/4/">一起来学 SpringBoot 2.x | 第四篇：整合Thymeleaf模板</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/java/sprintboot2/11/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="一起来学 SpringBoot 2.x | 第十一篇：集成Swagger在线调试" href="/docs/java/sprintboot2/11/">一起来学 SpringBoot 2.x | 第十一篇：集成Swagger在线调试</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href="/docs/java/sprintboot2/15/"><div class="hb-blog-post-card-img-none d-flex align-items-center justify-content-center">HB THEME</div></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="一起来学 SpringBoot 2.x | 第十五篇：actuator与spring-boot-admin 可以说的秘密" href="/docs/java/sprintboot2/15/">一起来学 SpringBoot 2.x | 第十五篇：actuator与spring-boot-admin 可以说的秘密</a></div></div></div></div></div><button class="slide-control-left">
<svg aria-hidden="true" class="bi bi-arrow-left-circlebi bi-arrow-left-circle hi-svg-inline slide-control-left-icon" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0m-4.5-.5a.5.5.0 010 1H5.707l2.147 2.146a.5.5.0 01-.708.708l-3-3a.5.5.0 010-.708l3-3a.5.5.0 11.708.708L5.707 7.5z"></path></svg><span class="visually-hidden">向左</span>
</button>
<button class="slide-control-right">
<svg aria-hidden="true" class="bi bi-arrow-right-circlebi bi-arrow-right-circle hi-svg-inline slide-control-right-icon" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0M4.5 7.5a.5.5.0 000 1h5.793l-2.147 2.146a.5.5.0 00.708.708l3-3a.5.5.0 000-.708l-3-3a.5.5.0 10-.708.708L10.293 7.5z"></path></svg><span class="visually-hidden">向右</span></button></div></div></div></div></div></div></div><footer class="hb-footer pt-4 pt-md-5 pb-2 pb-md-3 bg-body-tertiary"><div class="container-fluid container-lg px-4 px-md-3"><div class="row"><div class="hb-footer-site-info col mb-2 text-center"><div class="h5">程序员安仔</div><ul class="list-unstyled small mb-2"><li class="mt-2">一个只爱折腾技术的普通人</li><li class="mt-2">个人技术博客</li><li class="mt-2">Built with ❤️ from <a class="text-body-emphasis" href="https://gohugo.io/" target="_blank" rel="external" title="Hugo">Hugo</a>, <a class="text-body-emphasis" href="https://hugomods.com/" target="_blank" rel="external" title="Hugo Modules">Hugo Modules</a> and <a class="text-body-emphasis" href="https://hbstack.dev/" target="_blank" rel="external" title="HB Framework">HB Framework</a>.</li></ul><div class="hb-footer-socials d-flex mb-2 justify-content-center flex-wrap"><a class="hb-social p-2" href="mailto:andywuwu0728@gmail.com" target="_blank" rel="nofollow me" title="Email"><svg aria-hidden="true" class="bi bi-envelope-fillbi bi-envelope-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" style="color:%!s(bool=true)" viewBox="0 0 16 16" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M.05 3.555A2 2 0 012 2h12a2 2 0 011.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558zM6.761 8.83.191 12.857A2 2 0 002 14h12a2 2 0 001.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.801V4.697l-5.803 3.546z"></path></svg></a><a class="hb-social p-2" href="https://github.com/Andywugh" target="_blank" rel="nofollow me" title="GitHub"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" role="img" style="color:%!s(bool=true)" viewBox="0 0 24 24" width="1.75em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="hb-social p-2" href="/index.xml" target="_blank" rel="nofollow me" title="RSS"><svg aria-hidden="true" class="bi bi-rss-fillbi bi-rss-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" style="color:%!s(bool=true)" viewBox="0 0 16 16" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm1.5 2.5c5.523.0 10 4.477 10 10a1 1 0 11-2 0 8 8 0 00-8-8 1 1 0 010-2m0 4a6 6 0 016 6 1 1 0 11-2 0 4 4 0 00-4-4 1 1 0 010-2m.5 7a1.5 1.5.0 110-3 1.5 1.5.0 010 3"></path></svg></a><a class="hb-social p-2" href="https://www.zhihu.com/people/Andywuwu" target="_blank" rel="nofollow me" title="知乎"><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" role="img" style="color:#056de8" viewBox="0 0 24 24" width="1.75em" xmlns="http://www.w3.org/2000/svg"><title>Zhihu</title><path d="M5.721.0C2.251.0.0 2.25.0 5.719V18.28C0 21.751 2.252 24 5.721 24h12.56C21.751 24 24 21.75 24 18.281V5.72C24 2.249 21.75.0 18.281.0zm1.964 4.078c-.271.73-.5 1.434-.68 2.11h4.587c.545-.006.445 1.168.445 1.171H9.384a58.104 58.104.0 01-.112 3.797h2.712c.388.023.393 1.251.393 1.266H9.183a9.223 9.223.0 01-.408 2.102l.757-.604c.452.456 1.512 1.712 1.906 2.177.473.681.063 2.081.063 2.081l-2.794-3.382c-.653 2.518-1.845 3.607-1.845 3.607-.523.468-1.58.82-2.64.516 2.218-1.73 3.44-3.917 3.667-6.497H4.491c0-.015.197-1.243.806-1.266h2.71c.024-.32.086-3.254.086-3.797H6.598c-.136.406-.158.447-.268.753-.594 1.095-1.603 1.122-1.907 1.155.906-1.821 1.416-3.6 1.591-4.064.425-1.124 1.671-1.125 1.671-1.125zM13.078 6h6.377v11.33h-2.573l-2.184 1.373-.401-1.373h-1.219zm1.313 1.219v8.86h.623l.263.937 1.455-.938h1.456v-8.86z"></path></svg></a></div></div></div></div></footer><script src="/js/hb.5f4734770aa96e0900406704745bd07fd2ce5dd6121f0b52e2575c77d77f3840.js" integrity="sha256-X0c0dwqpbgkAQGcEdFvQf9LOXdYSHwtS4ldcd9d/OEA=" defer=""></script><script>"serviceWorker"in navigator&&window.addEventListener("DOMContentLoaded",function(){navigator.serviceWorker.register("/sw.js")})</script><script src="/js/search.71a6b0e374974a55de2726164698a316aafd04592dc5b1f8eaebc3fd1c62b17f.js" defer=""></script></body></html>